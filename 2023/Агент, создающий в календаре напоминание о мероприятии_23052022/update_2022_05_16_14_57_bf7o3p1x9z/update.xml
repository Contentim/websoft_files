<?xml version="1.0" encoding="utf-8"?>
<data>
	<basic>
		<id>bf7o3p1x9z</id>
		<create_date>2022-05-16T14:57:04+00:00</create_date>
		<server_version>2022.2.2.416 (2022-05-15)</server_version>
	</basic>
	<server_agents>
		<server_agent>
			<id>0x4BFA87F711FB643F</id>
			<code>CalendarEntryAgent_23052022</code>
			<name>Агент, создающий в календаре напоминание о мероприятии</name>
			<trigger_type>never</trigger_type>
			<period>1</period>
			<start_time>00:00</start_time>
			<finish_time>24:00</finish_time>
			<all_day>1</all_day>
			<start_day>1</start_day>
			<start_week_day>1</start_week_day>
			<last_run_date>2022-01-17T11:54:06+00:00</last_run_date>
			<type>code</type>
			<wvars>
				<wvar>
					<name>bUseTLSPort</name>
					<type>bool</type>
					<description>Использовать TLS порт</description>
					<silent>0</silent>
					<position>1</position>
				</wvar>
				<wvar>
					<name>bUseTLS</name>
					<type>bool</type>
					<description>Использовать TLS</description>
					<silent>0</silent>
					<position>2</position>
				</wvar>
			</wvars>
			<exec_code>
				<code_text>daysCount=7;// период за который отбираются мероприятия и по которым будут созданы напоминания ( текущая дата + daysCount )&#10;OrgUser="OrgUser";//пользователь, от имени которого будет создано в календаре напоминание&#10;OrgUserMail="";//адрес пользователя, от имени которого будет создано напоминание в календаре&#10;DefCharset="utf-8"//кодировка по умалчанию&#10;ReminderDays=1// частота создания напоминаний &#10;SendFeedback=false//отправлять пользователю от имени которого было послано напоминание сообщение о добавлении напоминания в календарь&#10;SendInvitationsToParticipants=true//отправлять уведомление для создания напоминания преподавателям&#10;SendInvitationsToLectors=true//If parameter is true then the invitations will be send to the trainers of the event&#10;SendInvitationsToResponsibleOfEvent=true//отправлять уведомление для создания напоминания ответственным за проведения мероприятия&#10;SendInvitationsToResponsibleOfEventPreparation=true//отправлять уведомление для создания напоминания ответственным за подготовку мероприятия&#10;ShowShortDescription=false&#10;//----------------------------------&#10;// часовой пояс времени, указываемого в параметрах карточки мероприятия, &#10;// если параметр отрицательный укажите (0-X), где X - число часов [десятичная дробь]&#10;BASE_TIME_ZONE = 3; &#10;//----------------------------------&#10;ModDate="28.04.2010 16:31"&#10;ShowAlert=false;&#10;alert('uniCalendarEntryAgent starts')&#10;try&#10;{&#10;&#9;ReminderDays=Int(ReminderDays)&#10;}&#10;catch(ex)&#10;{&#10;&#9;alert('Impossible to convert ReminderDays number to integer. There will be no reminder in the calendar.')&#10;&#9;ReminderDays=0;&#10;}&#10;&#10;if (ShowAlert) alert("ModDate="+ModDate);&#10;if (ShowAlert)&#10;{ &#10;&#9;alert("daysCount="+daysCount);&#10;&#9;alert("OrgUser="+OrgUser);&#10;&#9;alert("OrgUserMail="+OrgUserMail);&#10;&#9;alert("DefCharset="+DefCharset);&#10;&#9;alert("ReminderDays="+ReminderDays);&#10;&#9;alert("SendFeedback="+ReminderDays);&#10;&#9;alert("SendInvitationsToParticipants="+SendInvitationsToParticipants)&#10;&#9;alert("SendInvitationsToLectors="+SendInvitationsToLectors)&#10;&#9;alert("SendInvitationsToResponsibleOfEvent="+SendInvitationsToResponsibleOfEvent)&#10;&#9;alert("SendInvitationsToResponsibleOfEventPreparation="+SendInvitationsToResponsibleOfEventPreparation)&#10;&#9;alert("ShowShortDescription="+ShowShortDescription)&#10;}&#10;&#10;SmtpFound=false&#10;try&#10;{&#10;&#9;_client = SmtpClient();&#10;&#9;if ( global_settings.settings.own_org.smtp_server == '' )&#10;&#9;&#9;return false;&#10;&#9;_client.OpenSession( global_settings.settings.own_org.smtp_server );&#10;&#9;&#10;&#9;if ( tools_web.is_true( Param.GetOptProperty( 'bUseTLSPort', false ) ) )&#10;&#9;&#9;_client.UseTLSPort = true;&#10;&#9;else if ( tools_web.is_true( Param.GetOptProperty( 'bUseTLS', false ) ) )&#10;&#9;&#9;_client.UseTLS = true;&#10;&#10;&#9;if ( global_settings.settings.own_org.use_smtp_authenticate )&#9;&#10;&#9;&#9;_client.Authenticate( global_settings.settings.own_org.smtp_login, global_settings.settings.own_org.smtp_password );&#10;&#9;&#10;&#9;SmtpFound=true;&#10;}&#10;catch ( aa )&#10;{&#10;&#9;LogEvent( 'email', aa );&#10;&#9;alert( aa );&#9;&#9;&#10;}&#9;&#10;&#10;if (SmtpFound)&#10;{&#10;&#9;try&#10;&#9;{&#10;&#9;&#9;sender_address = global_settings.settings.own_org.email;&#10;&#9;&#10;&#9;&#9;_start_date=Date();&#10;&#9;&#9;_start_date=Date(DateNewTime(_start_date,00,00,00));&#10;&#9;&#9;_end_date=RawSecondsToDate( DateToRawSeconds(_start_date)  + (daysCount)*86400);&#10;&#9;&#9;_end_date=Date(DateNewTime(_end_date,23,59,59));&#10;&#9;&#9;&#10;&#9;&#9;&#10;&#9;&#9;&#10;&#9;&#9;if (ShowAlert) alert("start="+_start_date+" end="+_end_date);&#10;&#9;&#9;&#10;&#9;&#9;event_arr=XQuery( "for $obj in events where $obj/status_id='plan' and $obj/start_date!= null() and $obj/start_date&gt;= date('" +_start_date+"') and $obj/start_date&lt;=date ('" +_end_date+"') return $obj" );&#10;&#10;&#10;&#9;&#9;if (ShowAlert) alert('ArrayCount(event_arr)='+ArrayCount(event_arr));&#10;&#9;&#9;&#10;&#9;&#9;for ( _event in event_arr )&#10;&#9;&#9;{&#10;&#9;&#9;&#10;&#9;&#9;&#9;docEvent = OpenDoc( UrlFromDocID(_event.id));&#10;&#9;&#9;&#9;teEvent=docEvent.TopElem;&#10;&#9;&#9;&#9;&#10;&#9;&#9;&#9;file_id=String(_event.id).slice(String(_event.id).length-6) &#10;            PORTAL_URL = global_settings.settings.portal_base_url;&#9;&#10;&#9;&#9;&#10;&#9;&#9;&#9;_header_host=UrlAppendPath( PORTAL_URL,'/view_doc.html?mode=');&#10;&#9;&#9;&#9;_as_ap='"'+'events'+'"';&#10;&#9;&#9;&#9;_as_ap_arr=XQuery( 'for $elem in documents where $elem/code='+_as_ap+' return $elem' );&#10;&#9;&#9;&#9;_as_ap_arr_fe=ArrayOptFirstElem(_as_ap_arr);&#10;&#9;&#9;&#9;&#10;&#9;&#9;&#9;_doc_id='';&#10;&#9;&#9;&#9;if (_as_ap_arr_fe!=undefined)&#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;_doc_id=_as_ap_arr_fe.id;&#10;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#10;&#9;&#9;&#9;_subject="Invitation: "+_event.name+" ("+_event.start_date+")";&#10;&#9;&#9;&#9;&#10;&#9;&#9;&#9;if (ShowShortDescription)&#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;text_str='Тема: "'+teEvent.name+'" &lt;br/&gt;'+_header_host+'event&amp;object_id='+_event.id+'&amp;doc_id='+_doc_id;&#10;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;else&#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;text_str='Мероприятие "'+teEvent.name+'" запланировано: '+_header_host+'event&amp;object_id='+_event.id+'&amp;doc_id='+_doc_id;&#10;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;if (ShowAlert) alert('teEvent.name='+teEvent.name);&#10;&#9;&#9;&#9;_finish_date=Date(DateNewTime(_end_date,23,59,59));&#9;&#10;&#9;&#9;&#10;&#9;&#9;&#9;if (teEvent.finish_date.HasValue)&#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;_finish_date = teEvent.finish_date;&#10;&#9;&#9;&#9;}&#10;&#9;&#9;&#10;            try{&#10;&#9;&#9;&#9;&#9;if (teEvent.place_id.HasValue)&#10;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;objPlace = OpenDoc(UrlFromDocID(teEvent.place_id)).TopElem;&#10;&#9;&#9;&#9;&#9;&#9;PLACE_STR = Trim(objPlace.address);&#10;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;else&#10;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;PLACE_STR = "";&#10;&#9;&#9;&#9;&#9;}&#10;            }&#10;            catch(err){&#10;                alert(err);&#10;                PLACE_STR = "";&#10;            }&#10;            PLACE_STR += PLACE_STR!="" ? ", "+Trim(teEvent.place) : Trim(teEvent.place);&#10;&#10;&#9;&#9;&#9;if (ShowShortDescription)&#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;text='Тема: "'+teEvent.name+'" \r\n'+_header_host+'event&amp;object_id='+_event.id+'&amp;doc_id='+_doc_id;&#10;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;else&#10;&#9;&#9;&#9;{&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;text="Календарь\r\n\t " +text_str+"\n\t"+"Дата начала:"+teEvent.start_date+"\n\t"+"Дата окончания :"+_finish_date+"\n\t"+"Место проведения :"+teEvent.place+"\n\t"+"Комментарий:"+teEvent.comment+"\n\t";&#10;&#9;&#9;&#9;}&#10;&#9;&#10;&#9;&#9;&#9;if (ShowShortDescription)&#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;html_text='&#10;&lt;html&gt;&lt;body&gt;&#10;&lt;table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#666666"&gt;&#10;&#9;&lt;tr&gt;&#10;&#9;&#9;&lt;td&gt;&#9;&#10;&#9;&#9;&#9;&lt;table width="100%" cellspacing="1" cellpadding="0"&gt;&#10;&#9;&#9;&#9;&#9;&lt;tr bgcolor="#FFFFFF"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&lt;td align="left"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&lt;font style="font:Arial" style="font-size:10px"&gt;'+text_str+'&lt;/font&gt;&#10;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&lt;/tr&gt;&#10;&#9;&#9;&#9;&lt;/table&gt;&#10;&#9;&#9;&lt;/td&gt;&#10;&#9;&lt;/tr&gt;&#10;&lt;/table&gt;&#10;&lt;/body&gt;&lt;/html&gt;&#10;&#9;&#9;'&#10;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;else&#10;&#9;&#9;&#9;{&#10;&#9;&#9;html_text='&#10;&lt;html&gt;&lt;body&gt;&#10;&lt;table width="100%" border="0" cellspacing="0" cellpadding="0"&gt;&#10;&#9;&lt;tr&gt;&#10;&#9;&#9;&lt;td&gt;&#10;&#9;&#9;&#9;&lt;table width="100%" border="0" cellspacing="0" cellpadding="0"&gt;&#10;&#9;&#9;&#9;&lt;tr valign="top"&gt;&lt;td width="100%" valign="middle"&gt;&lt;font size="2" color="#4B6A85"&gt;Календарь&lt;/font&gt;&lt;br&gt;&#10;&#9;&#9;&#9;&lt;/td&gt;&lt;/tr&gt;&#10;&#9;&#9;&#9;&lt;/table&gt;&#10;&#9;&#9;&lt;/td&gt;&#10;&#9;&lt;/tr&gt;&#10;&#9;&lt;tr&gt;&#10;&#9;&#9;&lt;td&gt;&#10;&#9;&#9;&#10;&#9;&#9;&#9;&lt;table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#666666"&gt;&#10;&#9;&#9;&#9;&#9;&lt;tr&gt;&#10;&#9;&#9;&#9;&#9;&#9;&lt;td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&lt;table width="100%" cellspacing="1" cellpadding="0"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;tr bgcolor="#FFFFFF"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;Мероприятие:&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;td align="left"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;'+text_str+'&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/tr&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;tr bgcolor="#FFFFFF"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;Дата начала:&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;td align="left"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;'+teEvent.start_date+'&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/tr&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;tr bgcolor="#FFFFFF"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;Дата окончания:&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;td align="left"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;'+_finish_date+'&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/tr&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;tr bgcolor="#FFFFFF"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;Место проведения:&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;td align="left"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;'+teEvent.place+'&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/tr&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;tr bgcolor="#FFFFFF"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;Комментарий:&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;td align="left"&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;'+teEvent.comment+'&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/tr&gt;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&lt;/table&gt;&#10;&#9;&#9;&#9;&#9;&#9;&lt;/td&gt;&#10;&#9;&#9;&#9;&#9;&lt;/tr&gt;&#10;&#9;&#9;&#9;&lt;/table&gt;&#10;&#9;&#9;&#9;&#10;&#9;&#9;&lt;/td&gt;&#10;&#9;&lt;/tr&gt;&#10;&lt;/table&gt;&#10;&lt;/body&gt;&lt;/html&gt;&#10;&#9;&#9;'&#10;&#9;&#9;}&#10;&#10;&#9;&#9;&#9;arrRecipients=Array();&#10;&#9;&#9;&#9;counter=0;&#10;&#10;&#9;&#9;&#9;_arr_str=teEvent.custom_elems.ObtainChildByKey('f_n84u').value;&#10;&#9;&#9;&#9;_list=String(_arr_str).split(';');&#9;&#10;&#9;&#9;&#9;if (ShowAlert) alert('ArrayCount(_list)='+ArrayCount(_list));&#10;&#9;&#9;&#9;_is_changed=false;&#10;&#9;&#9;&#9;if (SendInvitationsToParticipants)&#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;for (iParticipantElem in teEvent.collaborators) &#10;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;_is_in_list=false;&#10;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;for (_elem in _list) &#10;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;if (Trim(_elem)==Trim(iParticipantElem.collaborator_id))&#10;&#9;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;_is_in_list=true;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;break;&#10;&#9;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;if (ShowAlert) alert('_is_in_list='+_is_in_list);&#10;&#9;&#9;&#9;&#9;&#9;if (_is_in_list!=true)&#10;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;_arr_str=_arr_str+iParticipantElem.collaborator_id+";";&#10;&#9;&#9;&#9;&#9;&#9;&#9;person_arr=XQuery( 'for $obj in collaborators where $obj/id='+iParticipantElem.collaborator_id+' return $obj');&#10;&#10;&#9;&#9;&#9;&#9;&#9;&#9;for ( _person in person_arr )&#10;&#9;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;if (ShowAlert)(_person.fullname);&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem=new Object;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem.email=_person.email;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem.fullname=_person.fullname&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;arrRecipients[counter]=NewElem&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;counter++&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;_is_changed=true;&#10;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;if (ShowAlert) alert('_is_changed='+_is_changed);&#10;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;}&#10;&#10;&#10;&#9;&#9;&#9;if (SendInvitationsToLectors)&#10;&#9;&#9;&#9;{&#10;                if (ShowAlert) alert('Преподаватели');&#10;&#9;&#9;&#9;&#9;for (iLectorElem in teEvent.lectors) &#10;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;_is_in_list=false;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;for (_elem in _list) &#10;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;if (Trim(_elem)==Trim(iLectorElem.lector_id))&#10;&#9;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;_is_in_list=true;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;break;&#10;&#9;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;if (ShowAlert) alert('_is_in_list='+_is_in_list);&#10;&#9;&#9;&#9;&#9;&#9;if (_is_in_list!=true)&#10;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;_arr_str=_arr_str+iLectorElem.lector_id+";";&#10;&#9;&#9;&#9;&#9;&#9;&#9;lector_arr=XQuery( 'for $obj in lectors where $obj/id='+iLectorElem.lector_id+' return $obj');&#10;&#10;&#9;&#9;&#9;&#9;&#9;&#9;for ( _lector in lector_arr )&#10;&#9;&#9;&#9;&#9;&#9;&#9;{&#10;                            if (_lector.type=='collaborator'){&#10;                                _person = ArrayOptFirstElem(XQuery( 'for $obj in collaborators where $obj/id='+_lector.person_id+' return $obj'));&#10;                                if (_person != undefined){&#10;                                    _person_fullname = _person.fullname;&#10;                                    _person_email = _person.email;&#10;                                }&#10;                            }&#10;                            else{&#10;                                _person_fullname = _lector.lector_fullname;&#10;                                _person_email = _lector.email;&#10;                            }&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;if (ShowAlert) alert(_person_fullname);&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem = new Object;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem.email = _person_email;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem.fullname = _person_fullname&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;arrRecipients[counter] = NewElem&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;counter++&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;_is_changed=true;&#10;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;if (ShowAlert) alert('_is_changed='+_is_changed);&#10;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;}&#10;&#10;&#10;&#9;&#9;&#9;if (SendInvitationsToResponsibleOfEvent)&#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;for (iTutorElem in teEvent.tutors) &#10;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;_is_in_list=false;&#10;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;for (_elem in _list) &#10;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;if (Trim(_elem)==Trim(iTutorElem.collaborator_id))&#10;&#9;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;_is_in_list=true;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;break;&#10;&#9;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;if (ShowAlert) alert('_is_in_list='+_is_in_list);&#10;&#9;&#9;&#9;&#9;&#9;if (_is_in_list!=true)&#10;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;_arr_str=_arr_str+iTutorElem.collaborator_id+";";&#10;&#9;&#9;&#9;&#9;&#9;&#9;person_arr=XQuery( 'for $obj in collaborators where $obj/id='+iTutorElem.collaborator_id+' return $obj');&#10;&#10;&#9;&#9;&#9;&#9;&#9;&#9;for ( _person in person_arr )&#10;&#9;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;if (ShowAlert)(_person.fullname);&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem=new Object;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem.email=_person.email;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem.fullname=_person.fullname&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;arrRecipients[counter]=NewElem&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;counter++&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;_is_changed=true;&#10;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;if (ShowAlert) alert('_is_changed='+_is_changed);&#10;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;}&#10;&#10;&#9;&#9;&#9;if (SendInvitationsToResponsibleOfEventPreparation)&#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;for (iEventPreparationElem in teEvent.even_preparations) &#10;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;_is_in_list=false;&#10;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;for (_elem in _list) &#10;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;if (Trim(_elem)==Trim(iEventPreparationElem.person_id))&#10;&#9;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;_is_in_list=true;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;break;&#10;&#9;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;if (ShowAlert) alert('_is_in_list='+_is_in_list);&#10;&#9;&#9;&#9;&#9;&#9;if (_is_in_list!=true)&#10;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;_arr_str=_arr_str+iEventPreparationElem.person_id+";";&#10;&#9;&#9;&#9;&#9;&#9;&#9;person_arr=XQuery( 'for $obj in collaborators where $obj/id='+iEventPreparationElem.person_id+' return $obj');&#10;&#10;&#9;&#9;&#9;&#9;&#9;&#9;for ( _person in person_arr )&#10;&#9;&#9;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;if (ShowAlert)(_person.fullname);&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem=new Object;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem.email=_person.email;&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NewElem.fullname=_person.fullname&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;arrRecipients[counter]=NewElem&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;counter++&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;&#9;&#9;_is_changed=true;&#10;&#9;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#9;if (ShowAlert) alert('_is_changed='+_is_changed);&#10;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#10;&#9;&#9;&#9;if (ShowAlert) &#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;for (iRecipientElem in arrRecipients)&#10;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;alert(iRecipientElem.fullname+' '+iRecipientElem.email)&#10;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;}&#10;&#10;&#9;&#9;&#9;if (_is_changed==true)&#10;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#10;&#9;&#9;&#9;&#9;teEvent.custom_elems.ObtainChildByKey('f_n84u').value=_arr_str;&#10;&#9;&#9;&#9;&#9;docEvent.Save();&#10;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;for (iRecipientElem in arrRecipients)&#10;&#9;&#9;&#9;{&#10;&#10;iValarmText='';&#10;if (ReminderDays&gt;0)&#10;{&#10;iValarmText='BEGIN:VALARM&#10;TRIGGER:-P'+ReminderDays+'D&#10;REPEAT:2&#10;DURATION:PT15M&#10;ACTION:DISPLAY&#10;DESCRIPTION:'+teEvent.name+' '+teEvent.start_date+'&#10;X-WR-ALARMUID:'+StrHexInt(Int(_event.id)-1)+'&#10;END:VALARM'&#10;}&#9;&#10;&#10;RSVP_STR=SendFeedback?'TRUE':'FALSE';&#10;&#10;DT_START = DateOffset(teEvent.start_date,(0-BASE_TIME_ZONE)*3600);&#10;DT_END = DateOffset(_finish_date,(0-BASE_TIME_ZONE)*3600);&#10;&#9;&#9;&#10;iCalendarText='BEGIN:VCALENDAR&#10;VERSION:2.0&#10;PRODID:-//WebSoft LTD//WebTutor 2//EN&#10;METHOD:REQUEST&#10;BEGIN:VEVENT&#10;DTSTART:'+StrReplace(StrReplace(StrLeftRange(StrXmlDate(DT_START),StrXmlDate(DT_START).lastIndexOf('+')),'-',''),':','')+'Z&#10;DTEND:'+StrReplace(StrReplace(StrLeftRange(StrXmlDate(DT_END),StrXmlDate(DT_END).lastIndexOf('+')),'-',''),':','')+'Z&#10;DTSTAMP:'+StrReplace(StrReplace(StrLeftRange(StrXmlDate(Date()),StrXmlDate(Date()).lastIndexOf('+')),'-',''),':','')+'Z&#10;TRANSP:OPAQUE&#10;SEQUENCE:0&#10;ATTENDEE;ROLE=REQ-PARTICIPANT;PARTSTAT=NEEDS-ACTION;CN="'+iRecipientElem.fullname+'";RSVP='+RSVP_STR+'&#10; :mailto:'+iRecipientElem.email+' &#10;CLASS:PUBLIC&#10;DESCRIPTION:'+teEvent.comment+'\n&#10;SUMMARY:'+teEvent.name+'&#10;ORGANIZER;CN="'+OrgUser+'":mailto:'+OrgUserMail+'&#10;UID:'+StrHexInt(_event.id)+'-WebTutor_Generated&#10;LOCATION:'+PLACE_STR+'\n&#10;'+iValarmText+'&#10;END:VEVENT&#10;END:VCALENDAR'&#10;&#9;&#10;if (ShowAlert) alert("iCalendarText="+iCalendarText);&#10;&#9;&#9; &#10;message_body ='X-Mru-BL: 0:0:2&#10;X-Mru-NR: 1&#10;X-Mru-OF: unknown (unknown)&#10;To: '+iRecipientElem.email+'&#10;Subject: '+_subject+'&#10;MIME-Version: 1.0&#10;From: '+sender_address+'&#10;Content-Type: multipart/mixed; boundary="=_mixed 004128EAC32576F1_="&#10;X-Spam: Not detected&#10;X-Mras: Ok&#10;&#10;This is a multipart message in MIME format.&#10;--=_mixed 004128EAC32576F1_=&#10;Content-Type: multipart/related; boundary="=_related 004128EAC32576F1_="&#10;&#10;&#10;--=_related 004128EAC32576F1_=&#10;Content-Type: multipart/alternative; boundary="=_alternative 004128EAC32576F1_="&#10;&#10;&#10;--=_alternative 004128EAC32576F1_=&#10;Content-Type: text/plain; charset='+DefCharset+'&#10;&#10;'+text+'&#10;&#10;--=_alternative 004128EAC32576F1_=&#10;Content-Type: text/html; charset='+DefCharset+'&#10;Content-Disposition: inline&#10;&#10;'+html_text+'&#10;&#10;--=_alternative 004128EAC32576F1_=&#10;Content-Type: text/calendar; method=REQUEST; charset='+DefCharset+';&#10;&#10;'+iCalendarText+'&#10;&#10;--=_alternative 004128EAC32576F1_=--&#10;--=_related 004128EAC32576F1_=&#10;&#10;--=_related 004128EAC32576F1_=--&#10;--=_mixed 004128EAC32576F1_=&#10;Content-Type: text/calendar; method=REQUEST; charset='+DefCharset+'; name="c'+file_id+'.ics"&#10;Content-Disposition: attachment; filename="c'+file_id+'.ics"&#10;&#10;'+iCalendarText+'&#10;--=_mixed 004128EAC32576F1_=--&#10;'&#10;&#9;&#9; &#10;&#9;&#10;&#10;&#9;&#9;&#9;&#9;//alert(message_body)&#10;&#9;&#9;&#9;&#9;try&#10;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;_client.SendMimeMessage(sender_address,iRecipientElem.email,message_body);&#10;&#9;&#9;&#9;&#9;&#9;LogEvent( 'email', 'Email sending to '+iRecipientElem.fullname+' (e-mail: ' +iRecipientElem.email + ') successful.' );&#10;&#9;&#9;&#9;&#9;}&#10;&#9;&#9;&#9;&#9;catch ( aa )&#10;&#9;&#9;&#9;&#9;{&#10;&#9;&#9;&#9;&#9;&#9;LogEvent( 'email', 'Email sending to '+iRecipientElem.fullname+' (e-mail: ' +iRecipientElem.email + ') failed. Error:'+ aa );&#10;&#9;&#9;&#9;&#9;}&#9;&#10;&#9;&#9;&#9;}&#10;&#9;&#9;&#10;&#9;&#9;}&#10;&#9;&#9;_client.CloseSession();&#10;&#9;&#9;//return true;&#10;&#9;}&#10;&#9;catch ( aa )&#10;&#9;{&#10;&#9;&#9;LogEvent( 'email', aa );&#10;&#9;&#9;alert( aa );&#10;&#9;&#9;_client.CloseSession();&#10;&#9;&#9;//return false;&#10;&#9;}&#9;&#10;}</code_text>
			</exec_code>
			<run_code><![CDATA[daysCount=7;// период за который отбираются мероприятия и по которым будут созданы напоминания ( текущая дата + daysCount )
OrgUser="OrgUser";//пользователь, от имени которого будет создано в календаре напоминание
OrgUserMail="";//адрес пользователя, от имени которого будет создано напоминание в календаре
DefCharset="utf-8"//кодировка по умалчанию
ReminderDays=1// частота создания напоминаний 
SendFeedback=false//отправлять пользователю от имени которого было послано напоминание сообщение о добавлении напоминания в календарь
SendInvitationsToParticipants=true//отправлять уведомление для создания напоминания преподавателям
SendInvitationsToLectors=true//If parameter is true then the invitations will be send to the trainers of the event
SendInvitationsToResponsibleOfEvent=true//отправлять уведомление для создания напоминания ответственным за проведения мероприятия
SendInvitationsToResponsibleOfEventPreparation=true//отправлять уведомление для создания напоминания ответственным за подготовку мероприятия
ShowShortDescription=false
//----------------------------------
// часовой пояс времени, указываемого в параметрах карточки мероприятия, 
// если параметр отрицательный укажите (0-X), где X - число часов [десятичная дробь]
BASE_TIME_ZONE = 3; 
//----------------------------------
ModDate="28.04.2010 16:31"
ShowAlert=false;
alert('uniCalendarEntryAgent starts')
try
{
	ReminderDays=Int(ReminderDays)
}
catch(ex)
{
	alert('Impossible to convert ReminderDays number to integer. There will be no reminder in the calendar.')
	ReminderDays=0;
}

if (ShowAlert) alert("ModDate="+ModDate);
if (ShowAlert)
{ 
	alert("daysCount="+daysCount);
	alert("OrgUser="+OrgUser);
	alert("OrgUserMail="+OrgUserMail);
	alert("DefCharset="+DefCharset);
	alert("ReminderDays="+ReminderDays);
	alert("SendFeedback="+ReminderDays);
	alert("SendInvitationsToParticipants="+SendInvitationsToParticipants)
	alert("SendInvitationsToLectors="+SendInvitationsToLectors)
	alert("SendInvitationsToResponsibleOfEvent="+SendInvitationsToResponsibleOfEvent)
	alert("SendInvitationsToResponsibleOfEventPreparation="+SendInvitationsToResponsibleOfEventPreparation)
	alert("ShowShortDescription="+ShowShortDescription)
}

SmtpFound=false
try
{
	_client = SmtpClient();
	if ( global_settings.settings.own_org.smtp_server == '' )
		return false;
	_client.OpenSession( global_settings.settings.own_org.smtp_server );
	
	if ( tools_web.is_true( Param.GetOptProperty( 'bUseTLSPort', false ) ) )
		_client.UseTLSPort = true;
	else if ( tools_web.is_true( Param.GetOptProperty( 'bUseTLS', false ) ) )
		_client.UseTLS = true;

	if ( global_settings.settings.own_org.use_smtp_authenticate )	
		_client.Authenticate( global_settings.settings.own_org.smtp_login, global_settings.settings.own_org.smtp_password );
	
	SmtpFound=true;
}
catch ( aa )
{
	LogEvent( 'email', aa );
	alert( aa );		
}	

if (SmtpFound)
{
	try
	{
		sender_address = global_settings.settings.own_org.email;
	
		_start_date=Date();
		_start_date=Date(DateNewTime(_start_date,00,00,00));
		_end_date=RawSecondsToDate( DateToRawSeconds(_start_date)  + (daysCount)*86400);
		_end_date=Date(DateNewTime(_end_date,23,59,59));
		
		
		
		if (ShowAlert) alert("start="+_start_date+" end="+_end_date);
		
		event_arr=XQuery( "for $obj in events where $obj/status_id='plan' and $obj/start_date!= null() and $obj/start_date>= date('" +_start_date+"') and $obj/start_date<=date ('" +_end_date+"') return $obj" );


		if (ShowAlert) alert('ArrayCount(event_arr)='+ArrayCount(event_arr));
		
		for ( _event in event_arr )
		{
		
			docEvent = OpenDoc( UrlFromDocID(_event.id));
			teEvent=docEvent.TopElem;
			
			file_id=String(_event.id).slice(String(_event.id).length-6) 
            PORTAL_URL = global_settings.settings.portal_base_url;	
		
			_header_host=UrlAppendPath( PORTAL_URL,'/view_doc.html?mode=');
			_as_ap='"'+'events'+'"';
			_as_ap_arr=XQuery( 'for $elem in documents where $elem/code='+_as_ap+' return $elem' );
			_as_ap_arr_fe=ArrayOptFirstElem(_as_ap_arr);
			
			_doc_id='';
			if (_as_ap_arr_fe!=undefined)
			{
				_doc_id=_as_ap_arr_fe.id;
			}
			
			_subject="Invitation: "+_event.name+" ("+_event.start_date+")";
			
			if (ShowShortDescription)
			{
				text_str='Тема: "'+teEvent.name+'" <br/>'+_header_host+'event&object_id='+_event.id+'&doc_id='+_doc_id;
			}
			else
			{
				text_str='Мероприятие "'+teEvent.name+'" запланировано: '+_header_host+'event&object_id='+_event.id+'&doc_id='+_doc_id;
			}
			if (ShowAlert) alert('teEvent.name='+teEvent.name);
			_finish_date=Date(DateNewTime(_end_date,23,59,59));	
		
			if (teEvent.finish_date.HasValue)
			{
				_finish_date = teEvent.finish_date;
			}
		
            try{
				if (teEvent.place_id.HasValue)
				{
					objPlace = OpenDoc(UrlFromDocID(teEvent.place_id)).TopElem;
					PLACE_STR = Trim(objPlace.address);
				}
				else
				{
					PLACE_STR = "";
				}
            }
            catch(err){
                alert(err);
                PLACE_STR = "";
            }
            PLACE_STR += PLACE_STR!="" ? ", "+Trim(teEvent.place) : Trim(teEvent.place);

			if (ShowShortDescription)
			{
				text='Тема: "'+teEvent.name+'" \r\n'+_header_host+'event&object_id='+_event.id+'&doc_id='+_doc_id;
			}
			else
			{			
				text="Календарь\r\n\t " +text_str+"\n\t"+"Дата начала:"+teEvent.start_date+"\n\t"+"Дата окончания :"+_finish_date+"\n\t"+"Место проведения :"+teEvent.place+"\n\t"+"Комментарий:"+teEvent.comment+"\n\t";
			}
	
			if (ShowShortDescription)
			{
						html_text='
<html><body>
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#666666">
	<tr>
		<td>	
			<table width="100%" cellspacing="1" cellpadding="0">
				<tr bgcolor="#FFFFFF">
					<td align="left">
						<font style="font:Arial" style="font-size:10px">'+text_str+'</font>
					</td>
				</tr>
			</table>
		</td>
	</tr>
</table>
</body></html>
		'
			}
			else
			{
		html_text='
<html><body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td>
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
			<tr valign="top"><td width="100%" valign="middle"><font size="2" color="#4B6A85">Календарь</font><br>
			</td></tr>
			</table>
		</td>
	</tr>
	<tr>
		<td>
		
			<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#666666">
				<tr>
					<td>
						<table width="100%" cellspacing="1" cellpadding="0">
							<tr bgcolor="#FFFFFF">
								<td>
									Мероприятие:
								</td>
								<td align="left">
									'+text_str+'
								</td>
							</tr>
							<tr bgcolor="#FFFFFF">
								<td>
									Дата начала:
								</td>
								<td align="left">
									'+teEvent.start_date+'
								</td>
							</tr>
							<tr bgcolor="#FFFFFF">
								<td>
									Дата окончания:
								</td>
								<td align="left">
									'+_finish_date+'
								</td>
							</tr>
							<tr bgcolor="#FFFFFF">
								<td>
									Место проведения:
								</td>
								<td align="left">
									'+teEvent.place+'
								</td>
							</tr>
							<tr bgcolor="#FFFFFF">
								<td>
									Комментарий:
								</td>
								<td align="left">
									'+teEvent.comment+'
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
			
		</td>
	</tr>
</table>
</body></html>
		'
		}

			arrRecipients=Array();
			counter=0;

			_arr_str=teEvent.custom_elems.ObtainChildByKey('f_n84u').value;
			_list=String(_arr_str).split(';');	
			if (ShowAlert) alert('ArrayCount(_list)='+ArrayCount(_list));
			_is_changed=false;
			if (SendInvitationsToParticipants)
			{
				for (iParticipantElem in teEvent.collaborators) 
				{
					_is_in_list=false;
					
					
					for (_elem in _list) 
					{
						if (Trim(_elem)==Trim(iParticipantElem.collaborator_id))
						{
							_is_in_list=true;
							break;
						}
					}
					if (ShowAlert) alert('_is_in_list='+_is_in_list);
					if (_is_in_list!=true)
					{
						
						_arr_str=_arr_str+iParticipantElem.collaborator_id+";";
						person_arr=XQuery( 'for $obj in collaborators where $obj/id='+iParticipantElem.collaborator_id+' return $obj');

						for ( _person in person_arr )
						{
							if (ShowAlert)(_person.fullname);
							NewElem=new Object;
							NewElem.email=_person.email;
							NewElem.fullname=_person.fullname
							arrRecipients[counter]=NewElem
							counter++		
						}
						
						_is_changed=true;
					}
					if (ShowAlert) alert('_is_changed='+_is_changed);
				}
				
			}


			if (SendInvitationsToLectors)
			{
                if (ShowAlert) alert('Преподаватели');
				for (iLectorElem in teEvent.lectors) 
				{
					_is_in_list=false;				
					
					for (_elem in _list) 
					{
						if (Trim(_elem)==Trim(iLectorElem.lector_id))
						{
							_is_in_list=true;
							break;
						}
					}
					if (ShowAlert) alert('_is_in_list='+_is_in_list);
					if (_is_in_list!=true)
					{
						
						_arr_str=_arr_str+iLectorElem.lector_id+";";
						lector_arr=XQuery( 'for $obj in lectors where $obj/id='+iLectorElem.lector_id+' return $obj');

						for ( _lector in lector_arr )
						{
                            if (_lector.type=='collaborator'){
                                _person = ArrayOptFirstElem(XQuery( 'for $obj in collaborators where $obj/id='+_lector.person_id+' return $obj'));
                                if (_person != undefined){
                                    _person_fullname = _person.fullname;
                                    _person_email = _person.email;
                                }
                            }
                            else{
                                _person_fullname = _lector.lector_fullname;
                                _person_email = _lector.email;
                            }
							if (ShowAlert) alert(_person_fullname);
							NewElem = new Object;
							NewElem.email = _person_email;
							NewElem.fullname = _person_fullname
							arrRecipients[counter] = NewElem
							counter++		
						}
						
						_is_changed=true;
					}
					if (ShowAlert) alert('_is_changed='+_is_changed);
				}
				
			}


			if (SendInvitationsToResponsibleOfEvent)
			{
				for (iTutorElem in teEvent.tutors) 
				{
					_is_in_list=false;
					
					
					for (_elem in _list) 
					{
						if (Trim(_elem)==Trim(iTutorElem.collaborator_id))
						{
							_is_in_list=true;
							break;
						}
					}
					if (ShowAlert) alert('_is_in_list='+_is_in_list);
					if (_is_in_list!=true)
					{
						
						_arr_str=_arr_str+iTutorElem.collaborator_id+";";
						person_arr=XQuery( 'for $obj in collaborators where $obj/id='+iTutorElem.collaborator_id+' return $obj');

						for ( _person in person_arr )
						{
							if (ShowAlert)(_person.fullname);
							NewElem=new Object;
							NewElem.email=_person.email;
							NewElem.fullname=_person.fullname
							arrRecipients[counter]=NewElem
							counter++		
						}
						
						_is_changed=true;
					}
					if (ShowAlert) alert('_is_changed='+_is_changed);
				}
				
			}

			if (SendInvitationsToResponsibleOfEventPreparation)
			{
				for (iEventPreparationElem in teEvent.even_preparations) 
				{
					_is_in_list=false;
					
					
					for (_elem in _list) 
					{
						if (Trim(_elem)==Trim(iEventPreparationElem.person_id))
						{
							_is_in_list=true;
							break;
						}
					}
					if (ShowAlert) alert('_is_in_list='+_is_in_list);
					if (_is_in_list!=true)
					{
						
						_arr_str=_arr_str+iEventPreparationElem.person_id+";";
						person_arr=XQuery( 'for $obj in collaborators where $obj/id='+iEventPreparationElem.person_id+' return $obj');

						for ( _person in person_arr )
						{
							if (ShowAlert)(_person.fullname);
							NewElem=new Object;
							NewElem.email=_person.email;
							NewElem.fullname=_person.fullname
							arrRecipients[counter]=NewElem
							counter++		
						}
						
						_is_changed=true;
					}
					if (ShowAlert) alert('_is_changed='+_is_changed);
				}
				
			}
			
			if (ShowAlert) 
			{
				for (iRecipientElem in arrRecipients)
				{
					alert(iRecipientElem.fullname+' '+iRecipientElem.email)
				}
			}

			if (_is_changed==true)
			{
			
				teEvent.custom_elems.ObtainChildByKey('f_n84u').value=_arr_str;
				docEvent.Save();
			}
				
			for (iRecipientElem in arrRecipients)
			{

iValarmText='';
if (ReminderDays>0)
{
iValarmText='BEGIN:VALARM
TRIGGER:-P'+ReminderDays+'D
REPEAT:2
DURATION:PT15M
ACTION:DISPLAY
DESCRIPTION:'+teEvent.name+' '+teEvent.start_date+'
X-WR-ALARMUID:'+StrHexInt(Int(_event.id)-1)+'
END:VALARM'
}	

RSVP_STR=SendFeedback?'TRUE':'FALSE';

DT_START = DateOffset(teEvent.start_date,(0-BASE_TIME_ZONE)*3600);
DT_END = DateOffset(_finish_date,(0-BASE_TIME_ZONE)*3600);
		
iCalendarText='BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//WebSoft LTD//WebTutor 2//EN
METHOD:REQUEST
BEGIN:VEVENT
DTSTART:'+StrReplace(StrReplace(StrLeftRange(StrXmlDate(DT_START),StrXmlDate(DT_START).lastIndexOf('+')),'-',''),':','')+'Z
DTEND:'+StrReplace(StrReplace(StrLeftRange(StrXmlDate(DT_END),StrXmlDate(DT_END).lastIndexOf('+')),'-',''),':','')+'Z
DTSTAMP:'+StrReplace(StrReplace(StrLeftRange(StrXmlDate(Date()),StrXmlDate(Date()).lastIndexOf('+')),'-',''),':','')+'Z
TRANSP:OPAQUE
SEQUENCE:0
ATTENDEE;ROLE=REQ-PARTICIPANT;PARTSTAT=NEEDS-ACTION;CN="'+iRecipientElem.fullname+'";RSVP='+RSVP_STR+'
 :mailto:'+iRecipientElem.email+' 
CLASS:PUBLIC
DESCRIPTION:'+teEvent.comment+'\n
SUMMARY:'+teEvent.name+'
ORGANIZER;CN="'+OrgUser+'":mailto:'+OrgUserMail+'
UID:'+StrHexInt(_event.id)+'-WebTutor_Generated
LOCATION:'+PLACE_STR+'\n
'+iValarmText+'
END:VEVENT
END:VCALENDAR'
	
if (ShowAlert) alert("iCalendarText="+iCalendarText);
		 
message_body ='X-Mru-BL: 0:0:2
X-Mru-NR: 1
X-Mru-OF: unknown (unknown)
To: '+iRecipientElem.email+'
Subject: '+_subject+'
MIME-Version: 1.0
From: '+sender_address+'
Content-Type: multipart/mixed; boundary="=_mixed 004128EAC32576F1_="
X-Spam: Not detected
X-Mras: Ok

This is a multipart message in MIME format.
--=_mixed 004128EAC32576F1_=
Content-Type: multipart/related; boundary="=_related 004128EAC32576F1_="


--=_related 004128EAC32576F1_=
Content-Type: multipart/alternative; boundary="=_alternative 004128EAC32576F1_="


--=_alternative 004128EAC32576F1_=
Content-Type: text/plain; charset='+DefCharset+'

'+text+'

--=_alternative 004128EAC32576F1_=
Content-Type: text/html; charset='+DefCharset+'
Content-Disposition: inline

'+html_text+'

--=_alternative 004128EAC32576F1_=
Content-Type: text/calendar; method=REQUEST; charset='+DefCharset+';

'+iCalendarText+'

--=_alternative 004128EAC32576F1_=--
--=_related 004128EAC32576F1_=

--=_related 004128EAC32576F1_=--
--=_mixed 004128EAC32576F1_=
Content-Type: text/calendar; method=REQUEST; charset='+DefCharset+'; name="c'+file_id+'.ics"
Content-Disposition: attachment; filename="c'+file_id+'.ics"

'+iCalendarText+'
--=_mixed 004128EAC32576F1_=--
'
		 
	

				//alert(message_body)
				try
				{
					_client.SendMimeMessage(sender_address,iRecipientElem.email,message_body);
					LogEvent( 'email', 'Email sending to '+iRecipientElem.fullname+' (e-mail: ' +iRecipientElem.email + ') successful.' );
				}
				catch ( aa )
				{
					LogEvent( 'email', 'Email sending to '+iRecipientElem.fullname+' (e-mail: ' +iRecipientElem.email + ') failed. Error:'+ aa );
				}	
			}
		
		}
		_client.CloseSession();
		//return true;
	}
	catch ( aa )
	{
		LogEvent( 'email', aa );
		alert( aa );
		_client.CloseSession();
		//return false;
	}	
}]]></run_code>
			<is_std>0</is_std>
			<doc_info>
				<creation>
					<user_login>user1</user_login>
					<date>2010-05-25T05:27:56+00:00</date>
				</creation>
				<modification>
					<user_login>user1</user_login>
					<user_id>0x5555555555555501</user_id>
					<date>2022-05-16T14:56:34+00:00</date>
				</modification>
			</doc_info>
		</server_agent>
	</server_agents>
</data>
